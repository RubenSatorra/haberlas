<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ajedrez pero guapo.</title>
    <link rel="stylesheet" href="css/chessboard-1.0.0.min.css">
    <script src="js/jquery.js"></script>
    <script src="js/chessboard-1.0.0.min.js"></script>
    <script src="js/chess.js"></script>
    <script src="js/stockfish.js"></script>
    
    <style>
        body{
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            max-width: 100vw;
            min-height: 100vh;
            background: #EEAECA;
            background: radial-gradient(circle,rgba(238, 174, 202, 1) 0%, rgba(148, 187, 233, 1) 100%);
            overflow: hidden; /* Esto deberÃ­a arreglar el jugar negras en movil (espero)*/
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }
        .container{
            display: flex;
            width: 100%;
            justify-content: center;
            align-items: center;
            margin: 20px 0;
            flex-shrink: 1;
        }
        #chessboard {
            width: 85vmin;
            height: 85vmin;
            max-width: 450px;
            max-height: 450px;
        }
        .info {
            text-align: center;
            margin-top: 20px;
            font-size: 18px;
            font-weight: bold;
        }
        .highlight-red-check{
            box-shadow: inset 0 0 3px 3px red;
        }
        button, select {
            margin: 5px;
            padding: 8px 12px;
            font-size: 14px;
            flex:1;
            min-width:140px;
        }
        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        #toggleBot{
        
            min-width: 220px;
        }
        button:hover {
            background-color: #45a049;
        }
        .controls {
            display: flex;
            flex-direction: row;
            overflow: hidden;
            flex-wrap: wrap;
            max-width: 100vw;
            justify-content: center;
            text-align: center;
            margin: 20px;
        }

        .controls-row {
        
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 5px;
            width: 100%;
            margin: 5px 0;

        }

        .status-container{
        
            width: 100%;
            margin-bottom: 15px;
            font-size: 18px;
            font-weight: bold;

        }

        @media (max-width: 768px){
        
            .controls{
                
                width: 95%;
                margin: 10px auto;

            }
            button, select{
            
                min-width: 120px;
                padding: 10px;
                font-size: 13px;

            }
            #toggleBot{
            
                min-width: 180px;

            }
        }

        @media (max-width: 480px){
        
            button,select {
            
                min-width: 100%;
                margin: 3px 0;
            }

            .controls-row{
                flex-direction: column;
                align-items: center;
            }

        }

    </style>
</head>
<body>
    
    <div class="container">
        <div id="chessboard"></div>
    </div>
    
    <div class="controls">
        <div class="status-container">
            <label id="chessStatus" class="info">Estado del juego</label><br>
            
        </div>
        <div class="controls-row">
            
            <select name="botDifficulty" id="botDifficulty">
                <option value="1">Profundidad 1</option>
                <option value="2">Profundidad 2</option>
                <option value="3">Profundidad 3</option>
                <option value="4">Profundidad 4</option>
                <option value="5">Profundidad 5 ðŸ˜³</option>
            </select>
            
        </div>
        <select name="playerColor" id="playerColor">
            <option value="white">Jugar blancas</option>
            <option value="black" selected>Jugar negras</option>
            <option value="both">Te da igual? (como todo...)</option>
        </select>
        <button id="resetButton">Reiniciar partida</button>
        <div class="controls-row">
            <button id="toggleBot">Activar movimientos automÃ¡ticos del bot</button>
            
        </div>
    </div>

    <script type="text/javascript">
        let board, game;
        let stockfish;
        let botActive = false;
        let playerColor = 'black';
        let botThinking = false;
        let stockfishReady = false;

        game = new Chess();

        // Inicializar Stockfish con manejo de estado
        function initStockfish() {
            stockfish = new Worker('js/stockfish.js');
            
            // Para debug: ver todos los mensajes
            stockfish.addEventListener('message', function(e) {
                console.log('Stockfish:', e.data);
            });
            
            stockfish.onmessage = function(event) {
                const message = event.data;
                console.log("Stockfish dice:", message);

                // Cuando Stockfish estÃ¡ listo despuÃ©s de 'uci'
                if (message === 'uciok') {
                    stockfishReady = true;
                    console.log("Stockfish listo para configurar");
                    setStockfishDifficulty(2);
                }
                
                // Cuando estÃ¡ listo despuÃ©s de configurar
                else if (message === 'readyok') {
                    console.log("Stockfish completamente configurado");
                }
                
                // Procesar movimiento del bot
                else if (message.includes('bestmove')) {
                    if (!botActive || !botThinking) return;
                    
                    const parts = message.split(' ');
                    const bestMove = parts[1];
                    
                    if (bestMove && bestMove !== 'none') {
                        // Aplicar el movimiento
                        const move = game.move({
                            from: bestMove.substring(0, 2),
                            to: bestMove.substring(2, 4),
                            promotion: bestMove.length > 4 ? bestMove.substring(4, 5) : 'q'
                        });

                        if (move) {
                            board.position(game.fen());
                            updateStatus();
                            checkTurn();
                        }
                    }
                    botThinking = false;
                }
            };

            stockfish.onerror = function(error) {
                console.error('Error en Stockfish Worker:', error);
                $("#chessStatus").html("Error cargando Stockfish");
            };

            // Iniciar protocolo UCI
            stockfish.postMessage('uci');
            stockfish.postMessage('isready');
        }

        // Configurar dificultad - VERSIÃ“N SIMPLIFICADA
        function setStockfishDifficulty(level) {
            if (!stockfishReady) {
                console.warn("Stockfish no estÃ¡ listo aÃºn");
                return;
            }
            
            // Solo configuramos el nivel de habilidad para evitar problemas
            const skillLevel = Math.min(20, level * 4);
            console.log(`Configurando dificultad: nivel ${level}, skill ${skillLevel}`);
            
            stockfish.postMessage(`setoption name Skill Level value ${skillLevel}`);
            stockfish.postMessage('isready');
        }

        // Pedir movimiento al bot
        function getBotMove() {
            if (!botActive || botThinking || game.game_over() || !stockfishReady) {
                console.log("No se puede mover el bot:", {
                    botActive, botThinking, gameOver: game.game_over(), stockfishReady
                });
                return;
            }

            // Verificar si es turno del bot
            const currentTurn = game.turn();
            const isBotTurn = 
                (playerColor === 'white' && currentTurn === 'b') ||
                (playerColor === 'black' && currentTurn === 'w');
            
            if (!isBotTurn && playerColor !== 'both') {
                console.log("No es turno del bot");
                return;
            }

            console.log("Calculando movimiento del bot...");
            botThinking = true;
            updateStatus();
            
            // Configurar posiciÃ³n y calcular
            const fen = game.fen();
            console.log("FEN enviado a Stockfish:", fen);
            
            stockfish.postMessage(`position fen ${fen}`);
            
            const difficulty = parseInt(document.getElementById('botDifficulty').value);
            const thinkTime = 1000 + (difficulty * 500);
            
            stockfish.postMessage(`go movetime ${thinkTime}`);
        }

        // Verificar turno
        function checkTurn() {
            if (!botActive || game.game_over() || !stockfishReady) return;

            const turn = game.turn();

            if (playerColor === 'both') {
                // Modo ambos: el bot juega ambos lados
                setTimeout(() => getBotMove(), 500);
                return;
            }

            if ((playerColor === 'white' && turn === 'b') ||
                (playerColor === 'black' && turn === 'w')) {
                setTimeout(() => getBotMove(), 500);
            }
        }

        function getKeyByValue(object, value) {
            for (let key in object) {
                if (object[key] === value) {
                    return key;
                }
            }
            return null;
        }

        updateStatus();

        let config = {
            position: 'start',
            pieceTheme: "/img/chesspieces/wikipedia/{piece}.png",
            showNotation: true,
            draggable: true,
            dropOffBoard: 'snapback',
            snapbackSpeed: 200,
            snapSpeed: 50,
            onDrop: onDrop,
            onSnapEnd: onSnapEnd,
            onDragStart: onDragStart,
            onMouseoverSquare: onMouseoverSquare,
            onMouseoutSquare: onMouseoutSquare
        }

        board = Chessboard('chessboard', config);
        initStockfish();
        function onDragStart(source, piece) {
            if (game.game_over() || botThinking) return false;
            
            // Si el bot no estÃ¡ activo, permitir todo
            if (!botActive) return true;

            const turn = game.turn();
            const pieceColor = piece.charAt(0); // 'w' o 'b' del string de la pieza

            // Verificar si la pieza es del color correcto
            if (playerColor === 'both') {
                // Si juega ambos colores, solo verificar que sea su turno
                return (pieceColor === turn);
            }

            // Para modo normal: verificar que la pieza sea del color del jugador Y sea su turno
            if (playerColor === 'white') {
                return (pieceColor === 'w' && turn === 'w'); // Solo puede mover blancas en turno de blancas
            } else if (playerColor === 'black') {
                return (pieceColor === 'b' && turn === 'b'); // Solo puede mover negras en turno de negras
            }
            
            return false;
        }

        // Event handlers
        $('#resetButton').on('click', function() {
            game.reset();
            board.position(game.fen());
            $("#chessStatus").html("Nueva Partida");
            updateStatus();

            if (botActive && playerColor !== 'white') {
                setTimeout(() => getBotMove(), 500);
            }
        });

        $('#toggleBot').on('click', function() {
            botActive = !botActive;
            updateBotButton();

            if (botActive) {
                if (!stockfishReady) {
                    alert("Stockfish aÃºn no estÃ¡ listo. Espera un momento.");
                    botActive = false;
                    updateBotButton();
                    return;
                }
                checkTurn();
            }

            updateStatus();
        });

        $('#playerColor').on('change', function() {
            playerColor = $(this).val();
            updateStatus();

            if (botActive) {
                checkTurn();
            }
        });

        $('#botDifficulty').on('change', function() {
            const level = parseInt($(this).val());
            setStockfishDifficulty(level);
        });

        $('#botMoveButton').on('click', function() {
            if (!botActive) {
                alert("Primero activa el bot");
                return;
            }
            if (!stockfishReady) {
                alert("Stockfish aÃºn no estÃ¡ listo");
                return;
            }
            getBotMove();
        });

        function onDrop(source, target) {
            if (botThinking) {
                console.log("Bot pensando, movimiento bloqueado");
                return 'snapback';
            }

            let move = game.move({
                from: source,
                to: target,
                promotion: 'q',
            });

            if (move === null) {
                return 'snapback';
            }

            removeRedSquares();
            removeGreySquares();
            
            board.position(game.fen());
            updateStatus();

            if (botActive) {
                setTimeout(() => checkTurn(), 500);
            }

            return true;
        }

        function updateStatus() {


            removeRedSquares();

            let prevColor = (game.turn() === 'w') ? "Negras" : "Blancas";

            if (game.in_check()) {
                let kingPosition = getKeyByValue(board.position(), game.turn() + 'K');
                redSquare(kingPosition);
            }

            if (game.in_checkmate()) {
                $("#chessStatus").html("Â¡Jaque mate! " + prevColor + " ganan.");
                botActive = false;
                updateBotButton();
            } else if (game.in_stalemate()) {
                $("#chessStatus").html("Tablas por estancamiento!");
                botActive = false;
                updateBotButton();
            } else if (game.in_threefold_repetition()) {
                $("#chessStatus").html("Tablas por repeticiÃ³n de movimientos!");
                botActive = false;
                updateBotButton();
            } else if (game.insufficient_material()) {
                $("#chessStatus").html("Tablas por material insuficiente!");
                botActive = false;
                updateBotButton();
            } else if (game.in_draw()) {
                $("#chessStatus").html("EstÃ¡s en tablas!");
                botActive = false;
                updateBotButton();
            } else {
                let turn = (game.turn() === 'w') ? "Blancas" : "Negras";
                let status = "Turno: " + turn;
                
                if (!stockfishReady) {
                    status += " (Inicializando Stockfish...)";
                } else if (botActive) {
                    if (botThinking) {
                        status += " (Bot pensando...ðŸ¤”)";
                    } else if ((playerColor === 'white' && game.turn() === 'b') ||
                            (playerColor === 'black' && game.turn() === 'w')) {
                        status += " (Turno del Bot)";
                    } else {
                        status += " (Tu turno)";
                    }
                }

                $("#chessStatus").html(status);
            }
        }

        function updateBotButton() {
            const button = document.getElementById('toggleBot');
            button.textContent = botActive ? "Desactivar Bot" : "Activar Bot";
            button.style.backgroundColor = botActive ? "#f44336" : "#4CAF50";
        }

        function onSnapEnd() {
            board.position(game.fen());
        }

        let whiteSquareGrey = '#a9a9a9';
        let blackSquareGrey = '#696969';

        function greySquare(square) {
            let $square = $('#chessboard .square-'+ square);
            let background = whiteSquareGrey;

            if($square.hasClass('black-3c85d')) {
                background = blackSquareGrey;
            }

            $square.css('background', background);
        }

        function removeGreySquares() {
            $('#chessboard .square-55d63').css('background','');
        }

        function redSquare(square) {
            let $square = $('#chessboard .square-' + square);
            $square.addClass('highlight-red-check');
        }

        function removeRedSquares() {
            $('#chessboard .square-55d63').removeClass('highlight-red-check');
        }

        function onMouseoverSquare(square, piece) {
            if (botThinking) return;
            
            let moves = game.moves({
                square: square,
                verbose: true
            });

            if (moves.length === 0) return;
            
            greySquare(square);
            
            for (let i = 0; i < moves.length; i++) {
                greySquare(moves[i].to);
            }
        }
        
        function onMouseoutSquare(square, piece) {
            removeGreySquares();
        }

        // Inicializar
        updateBotButton();
        updateStatus();

        // Para depurar porque me trae loco esto
        console.log("AplicaciÃ³n iniciada. Esperando Stockfish...");
    </script>
</body>
</html>
